name: Build Full Sing-Box SRS

on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * *" # 每天 UTC 22:30（UTC+8 06:30）
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout self
        uses: actions/checkout@v4

      # ========================
      # 基础环境
      # ========================
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y jq zip curl

      # ========================
      # 获取规则转换器
      # ========================
      - name: Checkout meta-rules-converter
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-converter
          path: converter

      # ========================
      # 获取规则源（完整）
      # ========================
      - name: Download rule sources
        run: |
          mkdir -p sources

          # domain list
          curl -L -o sources/geosite.txt https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Global/Global_Domain.txt
          curl -L -o sources/cn.txt https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/China/China_Domain.txt
          curl -L -o sources/private.txt https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Lan/Lan.txt
          curl -L -o sources/tracker.txt https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Download/Download_Domain.txt
          curl -L -o sources/ads.txt https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Advertising/Advertising_Domain.txt

          # gfwlist
          curl -L -o sources/gfwlist.txt https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt

          # geoip
          curl -L -o sources/geoip.csv https://raw.githubusercontent.com/Loyalsoldier/geoip/release/geoip.csv

      # ========================
      # 规则清洗 & 归一化
      # ========================
      - name: Normalize rule lists
        run: |
          mkdir -p normalized

          sed '/^\s*#/d;/^\s*$/d' sources/*.txt > normalized/all_domains.txt
          sort -u normalized/all_domains.txt -o normalized/all_domains.txt

      # ========================
      # 生成 sing-box rule-set JSON
      # ========================
      - name: Build rule-set json
        run: |
          mkdir -p ruleset/geosite ruleset/geoip

          cd converter

          # geosite
          go run ./ rule-set \
            --type sing-box \
            --format json \
            --output ../ruleset/geosite \
            ../normalized/all_domains.txt

          # geoip
          go run ./ geoip \
            --type sing-box \
            --format json \
            --input ../sources/geoip.csv \
            --output ../ruleset/geoip

      # ========================
      # 编译为 SRS
      # ========================
      - name: Compile SRS
        run: |
          mkdir -p srs/geosite srs/geoip

          for f in ruleset/geosite/*.json; do
            sing-box rule-set compile "$f" -o "srs/geosite/$(basename "${f%.json}.srs")"
          done

          for f in ruleset/geoip/*.json; do
            sing-box rule-set compile "$f" -o "srs/geoip/$(basename "${f%.json}.srs")"
          done

      # ========================
      # 打包
      # ========================
      - name: Zip artifacts
        run: |
          zip -r geosite-srs.zip srs/geosite
          zip -r geoip-srs.zip srs/geoip

      # ========================
      # 发布 Release
      # ========================
      - name: Upload release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          release_name: Sing-box SRS (Full)
          overwrite: true
          file_glob: true
          file: |
            geosite-srs.zip
            geoip-srs.zip
