name: Build sing-box SRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl jq python3 python3-pip
          pip3 install --upgrade pip

      # ------------------------------------------------------------
      # 1. 获取规则源（与你原脚本等价）
      # ------------------------------------------------------------
      - name: Fetch rule sources
        run: |
          mkdir -p source

          # blackmatrix7
          git clone --depth=1 https://github.com/blackmatrix7/ios_rule_script.git source/bm7

          # gfwlist
          curl -L https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt \
            -o source/gfwlist.txt

          # Windows Spy
          git clone --depth=1 https://github.com/crazy-max/WindowsSpyBlocker.git source/winspy

          # Steam CN
          curl -L https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/SteamCN.list \
            -o source/steamcn.list

          # Tracker
          git clone --depth=1 https://github.com/ngosang/trackerslist.git source/trackers

      # ------------------------------------------------------------
      # 2. 规则整理（domain / ip / asn）
      # ------------------------------------------------------------
      - name: Prepare geosite data
        run: |
          mkdir -p community/data community/data-lite

          # CN
          cp source/bm7/rule/Surge/China/*.list community/data/cn
          cp source/bm7/rule/Surge/China/*.list community/data-lite/cn

          # Apple / Google
          cp source/bm7/rule/Surge/Apple/*.list community/data/apple-cn
          cp source/bm7/rule/Surge/Google/*.list community/data/google-cn

          # GFW
          base64 -d source/gfwlist.txt | \
            grep -E '^\|\|' | sed 's/^\|\|//' \
            > community/data/gfw

          # Tracker
          cat source/trackers/trackers_all.txt \
            | grep -E '^[a-zA-Z0-9.-]+$' \
            > community/data/tracker

          cp community/data/gfw community/data-lite/gfw
          cp community/data/tracker community/data-lite/tracker

      # ------------------------------------------------------------
      # 3. GeoIP / ASN（直接用官方库）
      # ------------------------------------------------------------
      - name: Fetch geoip & asn
        run: |
          mkdir -p geoip geoip-lite asn

          curl -L https://raw.githubusercontent.com/Loyalsoldier/geoip/release/geoip-only-cn-private.dat \
            -o geoip/cn

          curl -L https://raw.githubusercontent.com/Loyalsoldier/geoip/release/geoip-only-cn-private.dat \
            -o geoip-lite/cn

          curl -L https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/release/asn.dat \
            -o asn/asn

      # ------------------------------------------------------------
      # 4. 转换为 sing-box rule-set json
      # ------------------------------------------------------------
      - name: Build sing-box rule-set json
        run: |
          mkdir -p sing-rule/full/geosite sing-rule/full/geoip sing-rule/lite/geosite sing-rule/lite/geoip

          go install github.com/SagerNet/sing-box/cmd/sing-box@latest

          # geosite full
          for f in community/data/*; do
            name=$(basename "$f")
            sing-box rule-set convert \
              --type geosite \
              --input "$f" \
              --output sing-rule/full/geosite/$name.json
          done

          # geosite lite
          for f in community/data-lite/*; do
            name=$(basename "$f")
            sing-box rule-set convert \
              --type geosite \
              --input "$f" \
              --output sing-rule/lite/geosite/$name.json
          done

          # geoip
          for f in geoip/*; do
            name=$(basename "$f")
            sing-box rule-set convert \
              --type geoip \
              --input "$f" \
              --output sing-rule/full/geoip/$name.json
          done

          for f in geoip-lite/*; do
            name=$(basename "$f")
            sing-box rule-set convert \
              --type geoip \
              --input "$f" \
              --output sing-rule/lite/geoip/$name.json
          done

      # ------------------------------------------------------------
      # 5. 编译为 .srs
      # ------------------------------------------------------------
      - name: Compile to SRS
        run: |
          mkdir -p srs/full srs/lite

          find sing-rule/full -name "*.json" | while read f; do
            out="srs/full/${f#sing-rule/full/}"
            out="${out%.json}.srs"
            mkdir -p "$(dirname "$out")"
            sing-box rule-set compile "$f" -o "$out"
          done

          find sing-rule/lite -name "*.json" | while read f; do
            out="srs/lite/${f#sing-rule/lite/}"
            out="${out%.json}.srs"
            mkdir -p "$(dirname "$out")"
            sing-box rule-set compile "$f" -o "$out"
          done

      # ------------------------------------------------------------
      # 6. 打包发布
      # ------------------------------------------------------------
      - name: Pack artifacts
        run: |
          tar -czf sing-box-srs.tar.gz srs

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-srs
          path: sing-box-srs.tar.gz
